pkgname=chromium
SKIP_ARCH_CHECK=1
pkgver=79.0.3945.88
vcs=git
gittag=${pkgver}
extra_urls="somethere/node_modules-${pkgver}.tar.gz"
# we update chromium separately from everything else
#relmon_id=13344

# updating node_modules:
# cd third_party/node
# ./update_npm_deps

# fetching webrtc branch_heads:
# git fetch origin '+refs/branch-heads/*:refs/remotes/branch-heads/*'

_check_and_clone_deps() {
    echo "vars = {}" > deps.py
    echo "" >> deps.py
    echo "def Var(key):" >> deps.py
    echo "    return vars[key]" >> deps.py
    echo "" >> deps.py
    cat ${1} >> deps.py

    cp ${srcdir}/../prepare_deps.py .
    python prepare_deps.py $(dirname `find_vcs_repo chromium`)

    bash filldeps.sh
    rm filldeps.sh prepare_deps.py deps.py
}

build() {
    cp ../gclient_args.gni build/config/

    cd third_party/node/
    tar xf ${TARBALLS_HOME}/node_modules-${pkgver}.tar.gz
    cd ../../

    # Allow building against system libraries in official builds
    sed -i 's/OFFICIAL_BUILD/GOOGLE_CHROME_BUILD/' \
        tools/generate_shim_headers/generate_shim_headers.py

    # https://crbug.com/893950
    sed -i -e 's/\<xmlMalloc\>/malloc/' -e 's/\<xmlFree\>/free/' \
        third_party/blink/renderer/core/xml/*.cc \
        third_party/blink/renderer/core/xml/parser/xml_document_parser.cc \
        third_party/libxml/chromium/libxml_utils.cc

    # Revert "Fix rendering performance regressions" which breaks https://chromium-review.googlesource.com/c/chromium/src/+/1597388
    git revert --no-edit 76ddcd29071bd4079c8776e0576268da5493f3ff

    # https://crbug.com/819294
    # IWYU: launch_manager.h uses std::vector
    git cherry-pick 97eb905ba262382bc3583078761c68f4452aea71

    # https://crbug.com/819294
    # IWYU: include algorithm to use std::lower_bound in ui/gfx/font.cc
    git cherry-pick f7c177d35242311ea7a2cf49a0980c61664f27ba

    # https://crbug.com/1014272
    patch -Np1 -i ../icu65.patch

    _check_and_clone_deps DEPS

    cd third_party/angle
    _check_and_clone_deps DEPS
    cd ../../

    cd third_party/openscreen/src
    _check_and_clone_deps DEPS
    cd ../../../

    cd buildtools
    _check_and_clone_deps DEPS
    cd ../

    python2 build/util/lastchange.py -o build/util/LASTCHANGE
    cp build/util/LASTCHANGE{,.blink}
    python2 build/util/lastchange.py -m GPU_LISTS_VERSION --revision-id-only --header gpu/config/gpu_lists_version.h
    python2 build/util/lastchange.py -m SKIA_COMMIT_HASH -s third_party/skia --header skia/ext/skia_commit_hash.h
    git log -1 --format='%ct' --grep=^Change-Id: HEAD > build/util/LASTCHANGE.committime
    rm -rf .git

    patch -Np0 -i ../chromium-skia-harmony.patch

    # fix "ERROR at //device/vr/buildflags/buildflags.gni:22:19: Undefined identifier"
    sed -i -e 's/checkout_openxr/false/g' device/vr/buildflags/buildflags.gni

    # Force script incompatible with Python 3 to use /usr/bin/python2
    sed -i '1s|python$|&2|' third_party/dom_distiller_js/protoc_plugins/*.py

    mkdir -p third_party/node/linux/node-linux-x64/bin
    ln -s /usr/bin/node third_party/node/linux/node-linux-x64/bin/

    export CCACHE_SLOPPINESS=time_macros
    export CC=clang
    export CXX=clang++
    export AR=ar
    export NM=nm

    export PATH=${PATH}:/usr/lib/openjdk/bin
    export TMPDIR=${srcdir}/temp
    mkdir -p ${TMPDIR}

    GN_CONFIG=(
        'custom_toolchain="//build/toolchain/linux/unbundle:default"'
        'host_toolchain="//build/toolchain/linux/unbundle:default"'
        'clang_use_chrome_plugins=false'
        'clang_use_default_sample_profile=false'
        'is_official_build=true'
        'treat_warnings_as_errors=false'
        'fieldtrial_testing_like_official_build=true'
        'ffmpeg_branding="Chrome"'
        'proprietary_codecs=true'
        'rtc_use_pipewire=true'
        'rtc_link_pipewire=true'
        'link_pulseaudio=false'
        'use_gnome_keyring=false'
        'use_sysroot=false'
        'linux_use_bundled_binutils=false'
        'use_custom_libcxx=false'
        'enable_hangout_services_extension=false'
        'enable_widevine=false'
        'enable_nacl=false'
        'enable_swiftshader=false'
        'use_kerberos=false'
        'use_libpci=false'
        'use_pulseaudio=false'
        'symbol_level=0'
        'icu_use_data_file=false'
    )

    # Facilitate deterministic builds (taken from build/config/compiler/BUILD.gn)
    CFLAGS+='   -Wno-builtin-macro-redefined'
    CXXFLAGS+=' -Wno-builtin-macro-redefined'
    CPPFLAGS+=' -D__DATE__=  -D__TIME__=  -D__TIMESTAMP__='

    # Do not warn about unknown warning options
    CFLAGS+='   -Wno-unknown-warning-option'
    CXXFLAGS+=' -Wno-unknown-warning-option'

    gn gen out/Release --args="${GN_CONFIG[*]}" --script-executable=/usr/bin/python2
    ninja -C out/Release chrome chrome_sandbox chromedriver
}

package() {
    install -vDm755  out/Release/chrome ${pkgdir}/usr/lib/chromium/chromium
    install -vDm4755 out/Release/chrome_sandbox ${pkgdir}/usr/lib/chromium/chrome-sandbox
    install -vDm755  out/Release/chromedriver ${pkgdir}/usr/lib/chromium/chromedriver
    mkdir -p ${pkgdir}/usr/bin
    ln -svf /usr/lib/chromium/chromium ${pkgdir}/usr/bin
    ln -svf /usr/lib/chromium/chromedriver ${pkgdir}/usr/bin/

    install -vDm644 out/Release/icudtl.dat ${pkgdir}/usr/lib/chromium
    install -vDm644 out/Release/gen/content/content_resources.pak ${pkgdir}/usr/lib/chromium/
    install -vm644 out/Release/{*.pak,*.bin} ${pkgdir}/usr/lib/chromium/

    cp -rv out/Release/locales ${pkgdir}/usr/lib/chromium/
}
