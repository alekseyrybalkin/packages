pkgname=chromium
SKIP_ARCH_CHECK=1
pkgver=80.0.3987.87
vcs=git
gittag=${pkgver}
extra_urls="somethere/node_modules-${pkgver}.tar.gz"
# we update chromium separately from everything else
#relmon_id=13344

# updating node_modules:
# cd third_party/node
# ./update_npm_deps

# fetching webrtc branch_heads:
# git fetch origin '+refs/branch-heads/*:refs/remotes/branch-heads/*'

_check_and_clone_deps() {
    echo "vars = {}" > deps.py
    echo "" >> deps.py
    echo "def Var(key):" >> deps.py
    echo "    return vars[key]" >> deps.py
    echo "" >> deps.py
    cat ${1} >> deps.py

    cp ${srcdir}/../prepare_deps.py .
    python prepare_deps.py $(dirname `find_vcs_repo chromium`)

    bash filldeps.sh
    rm filldeps.sh prepare_deps.py deps.py
}

build() {
    cp ../gclient_args.gni build/config/

    cd third_party/node/
    tar xf ${TARBALLS_HOME}/node_modules-${pkgver}.tar.gz
    cd ../../

    # Allow building against system libraries in official builds
    sed -i 's/OFFICIAL_BUILD/GOOGLE_CHROME_BUILD/' \
        tools/generate_shim_headers/generate_shim_headers.py

    # https://crbug.com/957519
    # [cros search service]: Include <cmath> for std::pow()
    git cherry-pick 8273f4d3130e06fd8b6bef87b07c936304b971d9
    # BookmarkModelMerger: Move RemoteTreeNode declaration to header.
    git cherry-pick cdf3e81ff49b200213d67d65558f2919222b60ab

    # https://crbug.com/989153
    # Fix shim header generation when unbundling ICU
    git cherry-pick dcad5af090528018599277dc5d7e160fb6b2d68e

    # https://crbug.com/1005508
    # Remove verbose logging in local unique font matching on Linux
    git cherry-pick 8500a125e9fba8bb84d185542155747ee7157ff8

    # https://crbug.com/1043042
    # Fix building with unbundled libxml
    git cherry-pick d3afade220ddb307e16a6dd4f2b0ec88b2af91e7

    # https://crbug.com/1046122
    # Fix browser frame view not getting a relayout after a state change
    git cherry-pick c73968d63c456d4aaf55c5cd439b42403a3bbeb1

    # https://crbug.com/1049258
    # Rename Relayout() in DesktopWindowTreeHostPlatform to ScheduleRelayout()
    git cherry-pick 5a2cd2409c7d65c019ad9f4595a4e85315857ac4
    # Rebuild Linux frame button cache when activation state changes
    git cherry-pick d10f885b9327399be9348b780967ebd6b7f2c4bc

    # https://crbug.com/893950
    sed -i -e 's/\<xmlMalloc\>/malloc/' -e 's/\<xmlFree\>/free/' \
        third_party/blink/renderer/core/xml/*.cc \
        third_party/blink/renderer/core/xml/parser/xml_document_parser.cc \
        third_party/libxml/chromium/*.cc

    _check_and_clone_deps DEPS

    cd third_party/angle
    _check_and_clone_deps DEPS
    cd ../../

    cd third_party/openscreen/src
    _check_and_clone_deps DEPS
    cd ../../../

    cd buildtools
    _check_and_clone_deps DEPS
    cd ../

    python2 build/util/lastchange.py -o build/util/LASTCHANGE
    cp build/util/LASTCHANGE{,.blink}
    python2 build/util/lastchange.py -m GPU_LISTS_VERSION --revision-id-only --header gpu/config/gpu_lists_version.h
    python2 build/util/lastchange.py -m SKIA_COMMIT_HASH -s third_party/skia --header skia/ext/skia_commit_hash.h
    git log -1 --format='%ct' --grep=^Change-Id: HEAD > build/util/LASTCHANGE.committime
    rm -rf .git

    patch -Np0 -i ../chromium-skia-harmony.patch

    # fix "ERROR at //device/vr/buildflags/buildflags.gni:22:19: Undefined identifier"
    sed -i -e 's/checkout_openxr/false/g' device/vr/buildflags/buildflags.gni

    # Force script incompatible with Python 3 to use /usr/bin/python2
    sed -i '1s|python$|&2|' third_party/dom_distiller_js/protoc_plugins/*.py

    mkdir -p third_party/node/linux/node-linux-x64/bin
    ln -s /usr/bin/node third_party/node/linux/node-linux-x64/bin/

    export CCACHE_SLOPPINESS=time_macros
    export CC=clang
    export CXX=clang++
    export AR=llvm-ar
    export NM=nm

    export PATH=${PATH}:/usr/lib/openjdk/bin
    export TMPDIR=${srcdir}/temp
    mkdir -p ${TMPDIR}

    GN_CONFIG=(
        'custom_toolchain="//build/toolchain/linux/unbundle:default"'
        'host_toolchain="//build/toolchain/linux/unbundle:default"'
        'clang_use_chrome_plugins=false'
        'clang_use_default_sample_profile=false'
        'is_official_build=true'
        'treat_warnings_as_errors=false'
        'fieldtrial_testing_like_official_build=true'
        'ffmpeg_branding="Chrome"'
        'proprietary_codecs=true'
        'rtc_use_pipewire=true'
        'rtc_link_pipewire=true'
        'link_pulseaudio=false'
        'use_gnome_keyring=false'
        'use_sysroot=false'
        'linux_use_bundled_binutils=false'
        'use_custom_libcxx=false'
        'enable_hangout_services_extension=false'
        'enable_widevine=false'
        'enable_nacl=false'
        'enable_swiftshader=false'
        'use_kerberos=false'
        'use_libpci=false'
        'use_pulseaudio=false'
        'symbol_level=0'
    )

    # Facilitate deterministic builds (taken from build/config/compiler/BUILD.gn)
    CFLAGS+='   -Wno-builtin-macro-redefined'
    CXXFLAGS+=' -Wno-builtin-macro-redefined'
    CPPFLAGS+=' -D__DATE__=  -D__TIME__=  -D__TIMESTAMP__='

    # Do not warn about unknown warning options
    CFLAGS+='   -Wno-unknown-warning-option'
    CXXFLAGS+=' -Wno-unknown-warning-option'

    gn gen out/Release --args="${GN_CONFIG[*]}" --script-executable=/usr/bin/python2
    ninja -C out/Release chrome chrome_sandbox chromedriver
}

package() {
    install -vDm755  out/Release/chrome ${pkgdir}/usr/lib/chromium/chromium
    install -vDm4755 out/Release/chrome_sandbox ${pkgdir}/usr/lib/chromium/chrome-sandbox
    install -vDm755  out/Release/chromedriver ${pkgdir}/usr/lib/chromium/chromedriver
    mkdir -p ${pkgdir}/usr/bin
    ln -svf /usr/lib/chromium/chromium ${pkgdir}/usr/bin
    ln -svf /usr/lib/chromium/chromedriver ${pkgdir}/usr/bin/

    install -vDm644 out/Release/icudtl.dat ${pkgdir}/usr/lib/chromium
    install -vDm644 out/Release/gen/content/content_resources.pak ${pkgdir}/usr/lib/chromium/
    install -vm644 out/Release/{*.pak,*.bin} ${pkgdir}/usr/lib/chromium/

    cp -rv out/Release/locales ${pkgdir}/usr/lib/chromium/
}
