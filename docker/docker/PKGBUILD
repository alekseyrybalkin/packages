NO_STRIPPING=1
pkgname=docker
pkgver=19.03.6
vcs=git
vcs_pkgname=docker-ce
gittag=v${pkgver}
relmon_id=11719
relmon_rules="skip_a,skip_b,skip_rc"

build() {
    _DOCKER_COMMIT=`git rev-parse HEAD`
    _TINI_COMMIT=`cat components/engine/hack/dockerfile/install/tini.installer | grep '^TINI_COMMIT=' | sed 's/^TINI_COMMIT=//g' | sed 's/ .*//g'`
    _LIBNETWORK_COMMIT=`cat components/engine/hack/dockerfile/install/proxy.installer | grep '^LIBNETWORK_COMMIT=' | sed 's/^LIBNETWORK_COMMIT=//g' | sed 's/ .*//g'`

    export GOPATH=${location}
    export PATH=${GOPATH}/bin:${PATH}

    # cli
    mkdir -p ${location}/src/github.com/docker
    cp -r components/cli ${location}/src/github.com/docker/
    cd ${location}/src/github.com/docker/cli/
    DISABLE_WARN_OUTSIDE_CONTAINER=1 make VERSION=$pkgver-ce dynbinary
    cd ${srcdir}

    # daemon
    cp -r components/engine ${location}/src/github.com/docker/docker
    cd ${location}/src/github.com/docker/docker/
    DOCKER_GITCOMMIT=${_DOCKER_COMMIT} \
        DOCKER_BUILDTAGS='seccomp journald' \
        VERSION=${pkgver}-ce \
        hack/make.sh dynbinary
    cd ${srcdir}

    # proxy
    cd ${location}/src/github.com/docker/
    git clone `find_vcs_repo libnetwork`
    cd libnetwork
    git checkout ${_LIBNETWORK_COMMIT}
    go build -ldflags="-linkmode=external" github.com/docker/libnetwork/cmd/proxy
    cd ${srcdir}

    # init
    mkdir -p ${location}/src/github.com/krallin
    cd ${location}/src/github.com/krallin/
    git clone `find_vcs_repo tini`
    cd tini
    git checkout ${_TINI_COMMIT}
    cmake .
    make tini-static
    cd ${srcdir}
}

package() {
    install -Dm755 ${location}/src/github.com/docker/cli/build/docker ${pkgdir}/usr/bin/docker
    install -Dm755 ${location}/src/github.com/docker/libnetwork/proxy ${pkgdir}/usr/bin/docker-proxy
    install -Dm755 ${location}/src/github.com/krallin/tini/tini-static ${pkgdir}/usr/bin/docker-init

    cd ${location}/src/github.com/docker/docker
    install -Dm755 {bundles/dynbinary-daemon,${pkgdir}/usr/bin}/dockerd

    install -Dm644 contrib/init/systemd/docker.service \
        ${pkgdir}/usr/lib/systemd/system/docker.service
    install -Dm644 contrib/init/systemd/docker.socket \
        ${pkgdir}/usr/lib/systemd/system/docker.socket
    install -Dm644 contrib/udev/80-docker.rules \
        ${pkgdir}/usr/lib/udev/rules.d/80-docker.rules

    install -Dm644 contrib/syntax/vim/syntax/dockerfile.vim \
        ${pkgdir}/usr/share/vim/vimfiles/syntax/dockerfile.vim
    install -Dm644 contrib/syntax/vim/ftdetect/dockerfile.vim \
        ${pkgdir}/usr/share/vim/vimfiles/ftdetect/dockerfile.vim
}

after_install() {
    getent group docker >/dev/null || groupadd --system docker
}

after_upgrade() {
    after_install
}

generated_files="etc/docker/key.json"
