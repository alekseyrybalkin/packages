#!/bin/bash

usage() {
  echo "usage:"
  echo "  kiin make"
  echo "  kiin download"
  echo "  kiin gen-db"
  echo "  kiin list-dups"
  echo "  kiin who-owns </full/path/to/file>"
  echo "  kiin who-uses-dir </full/path/to/dir>"
  echo "  kiin check-conflicts </path/to/package.xz>"
  echo "  kiin list-files </path/to/package.xz>"
  echo "  kiin list-dirs </path/to/package.xz>"
  echo "  kiin install </path/to/package.xz>"
  echo "  kiin upgrade </path/to/package.xz>"
  echo "  kiin ls"
  echo "  kiin uninstall <package>"
  echo "  kiin db-list-files <package>"
  echo "  kiin db-list-dirs <package>"
  echo "  kiin list-untracked <dir>"
  echo "  kiin check-system-integrity"
  echo "  kiin list-missing"
  echo "  kiin check-arch-updates"
}

if [ -z $1 ]; then
  usage
  exit 0
fi

case $1 in
  "make" | "download")
    if [ ! -f ./package.sh ]; then
      echo "no package.sh found, goodbye."
      exit 0
    fi
    location=`pwd`
    . ./package.sh

    pkgdir=${location}/kiin-dest
    ;;
esac
case $1 in
  "install" | "upgrade" | "uninstall" | "list-untracked" \
    | "check-system-integrity" | "list-missing")
    if [ `whoami` != 'root' ]; then
      echo "you must be root to run kiin $1"
      exit 0
    fi
    ;;
esac
case $1 in
  "who-owns" | "who-uses-dir" | "check-conflicts" | "list-files" \
    | "list-dirs" | "install" | "upgrade" | "uninstall" | "db-list-files" \
    | "db-list-dirs" | "list-untracked")
    if [ -z $2 ]; then
      echo "usage:" && usage | grep $1
      exit 0
    fi
    ;;
esac
case $1 in
  "uninstall" | "db-list-files" | "db-list-dirs")
    count=`kiin ls | grep $2 | wc -l`
    if [ $count = 0 ]; then
      echo "$2 is not installed"
      exit 0
    fi
    if [ $count -gt 1 ]; then
      echo "$2 is ambiguous (" `kiin ls | grep $2` ")"
      exit 0
    fi
    package=`kiin ls | grep $2`
    ;;
esac
case $1 in
  "check-conflicts" | "list-files" | "list-dirs" | "install" \
    | "upgrade")
    if [ ! -f $2 ]; then
      echo "$2 does not exist"
      exit 0
    fi
    ;;
esac

if [ $1 == "make" ]; then
  set -e
  if [[ ${srctar} ]]; then
    echo "unpacking ${srctar}..."
    tar xf ${srctar}
    cd ${srcdir}
  fi
  kiin_make

  maker=${location}/kiin_maker.sh
  cat > ${maker} << "EOF"
#!/bin/sh
cd ${location}
. ./package.sh
mkdir ${pkgdir}
if [[ ${srcdir} ]]; then
  cd ${srcdir}
fi
kiin_install
fix_symlinks.py

# fix /usr/share/info/dir
rm -fv ${pkgdir}/usr/share/info/dir
if [ -e ${pkgdir}/var ]; then
  echo " *** WARNING ***: package tries to use /var"
fi

# fix /usr/lib/perl5/5.16.1/x86_64-linux/perllocal.pod
if [ -e ${pkgdir}/usr/lib/perl5/5.16.1/x86_64-linux/perllocal.pod ]; then
  mv -v ${pkgdir}/usr/lib/perl5/5.16.1/x86_64-linux/perllocal.pod{,.$pkgname.podpart}
fi

cd ${location}
echo creating xz archive...
tar cfa kiin.${pkgname}-${pkgver}.tar.xz kiin-dest
EOF
  chmod +x ${maker}
  location=${location} srcdir=${srcdir} pkgdir=${pkgdir} \
    pkgname=${pkgname} pkgver=${pkgver} fakeroot ${maker}
  rm ${maker}
  rm -rf ${pkgdir}
  if [[ ${srcdir} ]]; then
    rm -rf ${srcdir}
  fi
  echo "kiin: all done!"
  exit 0
fi

if [ $1 = "download" ]; then
  for url in $urls; do
    if [[ $url == *midnight* ]]; then
      wget --no-check-certificate $url
    else
      wget $url
    fi
  done
  exit 0
fi

if [ $1 == 'gen-db' ]; then
  # add kiin-git-1 package
  tmpdir=/tmp/kiin-user/`uuidgen`
  mkdir -p $tmpdir
  cd $tmpdir
  git clone / kiin-dest 1>/dev/null
  rm -rf kiin-dest/.git
  tar cfa kiin.kiin-git-1.tar.xz kiin-dest
  mv kiin.kiin-git-1.tar.xz /sources/installed
  # add kiin-known-1 package
  tmpdir=/tmp/kiin-user/`uuidgen`
  mkdir -p $tmpdir
  cd $tmpdir
  mkdir kiin-dest
  cd kiin-dest
  mkdir -p boot/grub/i386-pc
  mkdir -p etc/{ssh,gtk-2.0}
  mkdir -p usr/{share/info,lib/perl5/5.16.1/x86_64-linux,lib/locale}
  mkdir -p usr/{lib/pango/1.8.0,lib/gdk-pixbuf-2.0/2.10.0}
  touch boot/grub/i386-pc/core.img
  touch boot/grub/grubenv
  touch etc/group
  touch etc/gshadow-
  touch etc/shadow-
  touch etc/gshadow
  touch etc/passwd
  touch etc/shadow
  touch etc/.pwd.lock
  touch etc/ssh/ssh_host_key.pub
  touch etc/ssh/ssh_host_dsa_key
  touch etc/ssh/ssh_host_rsa_key.pub
  touch etc/ssh/ssh_host_key
  touch etc/ssh/ssh_host_dsa_key.pub
  touch etc/ssh/ssh_host_ecdsa_key.pub
  touch etc/ssh/ssh_host_rsa_key
  touch etc/ssh/ssh_host_ecdsa_key
  touch etc/passwd-
  touch etc/group-
  touch usr/share/info/dir
  touch usr/lib/perl5/5.16.1/x86_64-linux/perllocal.pod
  touch usr/lib/locale/locale-archive
  touch usr/lib/pango/1.8.0/modules.cache
  touch usr/lib/gdk-pixbuf-2.0/2.10.0/loaders.cache
  touch etc/gtk-2.0/gtk.immodules
  cd ..
  tar cfa kiin.kiin-known-1.tar.xz kiin-dest
  mv kiin.kiin-known-1.tar.xz /sources/installed
  # generate db
  db_manager.py gen-db
  exit 0
fi

if [ $1 == 'list-dups' ]; then
  echo "select * from (select count(id) as cnt, name from file \
    where permissions not like 'd%' group by name \
    order by cnt desc) where cnt > 1;" | sqlite3 /sources/kiin-db/kiin.sqlite3 \
    | sed 's/|/\ \ /g'
  exit 0
fi

if [ $1 == 'who-owns' ]; then
  echo "select name,version from package where id in \
    (select distinct package_id from file where name = '$2' \
    and permissions not like 'd%');" | sqlite3 /sources/kiin-db/kiin.sqlite3 \
    | sed 's/|/\-/g' | sort
  exit 0
fi

if [ $1 == 'who-uses-dir' ]; then
  dir=`echo $2 | sed 's/\/$//g'`
  echo "select name,version from package where id in \
    (select distinct package_id from file where name = '$dir/' \
    and permissions like 'd%');" | sqlite3 /sources/kiin-db/kiin.sqlite3 \
    | sed 's/|/\-/g' | sort
  exit 0
fi

if [ $1 == 'check-conflicts' ]; then
  for i in `kiin list-files $2`; do
    if [ -e $i ]; then
      echo $i already exists on filesystem
    fi
  done
  for i in `kiin list-dirs $2`; do
    i=`echo $i | sed 's/\/$//g'`
    if [ -e $i ]; then
      if [ ! -d $i ]; then
        echo "$i already exists on filesystem and is not a dir"
      fi
    fi
  done
  exit 0
fi

if [ $1 == 'list-files' ]; then
  tar -tvf $2 | sed 's/kiin-dest//g' | tr -s ' ' | grep -E '^[-lpscbh].*' | cut -d ' ' --fields=6 | sort
  exit 0
fi

if [ $1 == 'list-dirs' ]; then
  tar -tvf $2 | sed 's/kiin-dest//g' | tr -s ' ' | grep -E '^d.*' | cut -d ' ' --fields=6 | sort
  exit 0
fi

if [ $1 == 'install' ]; then
  if [ `kiin list-dups | wc -l` != '0' ]; then
    echo "where are duplicates in the system, not installing"
    exit 0
  fi
  if [ `kiin check-conflicts $2 | wc -l` != '0' ]; then
    echo "where are conflicts, not installing"
    exit 0
  fi
  startdir=`pwd`
  tmpdir=/tmp/kiin/`uuidgen`
  mkdir -p $tmpdir
  tar xf $2 -C $tmpdir
  for dir in `kiin list-dirs $2`; do
    if [ ! -d $dir ]; then
      prototype=$tmpdir/kiin-dest$dir
      mkdir -pv $dir
      chmod `stat -c %a $prototype` $dir
      #echo "chown `stat -c %U $prototype`:`stat -c %G $prototype` $dir"
    fi
  done
  for file in `kiin list-files $2`; do
    prototype=$tmpdir/kiin-dest$file
    cp -av $prototype $file
  done

  # recreate /usr/share/info/dir
  cd /usr/share/info
  rm -v dir
  for f in *; do
    install-info $f dir 2>/dev/null
  done

  # fix /usr/lib/perl5/5.16.1/x86_64-linux/perllocal.pod
  cd /usr/lib/perl5/5.16.1/x86_64-linux
  if [ -e perllocal.pod ]; then
    rm -v perllocal.pod
  fi
  for f in `find . -name "*.podpart"`; do
    cat $f >> perllocal.pod
  done

  cd $startdir
  sudo -u rybalkin mv -v $2 /sources/installed
  sudo -u rybalkin kiin gen-db

  exit 0
fi

if [ $1 == 'upgrade' ]; then
  if [ `kiin list-dups | wc -l` != '0' ]; then
    echo "where are duplicates in the system, not upgrading"
    exit 0
  fi
  package=`echo $(basename $2) | sed 's/kiin\.//g' | sed 's/\.tar\.xz//g' | sed 's/-[^-]*$//g'`
  new_version=`echo $(basename $2) | sed 's/kiin\.//g' | sed 's/\.tar\.xz//g' | sed "s/$package-//g"`
  old_version=`echo "select version from package where name='$package';" \
    | sqlite3 /sources/kiin-db/kiin.sqlite3`
  if [ -z $old_version ]; then
    echo "no such package installed, sorry"
    exit 0
  fi
  startdir=`pwd`
  echo "upgrading $package from $old_version to $new_version" | tee -a $upgrade_log
  upgrade_log=/tmp/kiin/upgrade_log-`uuidgen`
  tmpdir=/tmp/kiin/`uuidgen`
  mkdir -p $tmpdir
  tar xf $2 -C $tmpdir
  for i in `kiin list-files $2`; do
    owners=`kiin who-owns $i`
    owner_count=`echo $owners | wc -w`
    [[ $owner_count = 0 ]] && [[ -e $i ]] && {
      echo "$i has no owners: $owners, but exists on filesystem, not upgrading"
      exit 0
    }
    [[ $owner_count > 0 ]] && [[ $owners != "$package-$old_version" ]] && {
      echo "$i has following owners: $owners, not upgrading"
      exit 0
    }
  done
  for i in `kiin list-dirs $2`; do
    i=`echo $i | sed 's/\/$//g'`
    if [ -e $i ]; then
      if [ ! -d $i ]; then
        echo "$i already exists on filesystem and is not a dir, not upgrading"
        exit 0
      fi
    fi
  done
  # actual destructive shit
  for dir in `kiin list-dirs $2`; do
    if [ ! -d $dir ]; then
      prototype=$tmpdir/kiin-dest$dir
      mkdir -pv $dir | tee -a $upgrade_log
      chmod -v `stat -c %a $prototype` $dir | tee -a $upgrade_log
    fi
  done
  for file in `kiin db-list-files $package-$old_version`; do
    if [ ! -e $tmpdir/kiin-dest$file ]; then
      rm -v $file | tee -a $upgrade_log
    fi
  done
  for file in `kiin list-files $2`; do
    prototype=$tmpdir/kiin-dest$file
    # the only place with overwriting
    rm -vf $file 2>&1 | tee -a $upgrade_log
    cp -avf $prototype $file 2>&1 | tee -a $upgrade_log
  done
  for dir in `kiin db-list-dirs $package-$old_version \
    | awk '{ print length, $0 }' | sort -n -r | cut -d " " --fields=2`; do
    users=`kiin who-uses-dir $dir`
    user_count=`echo $users | wc -w`
    [[ $user_count = 1 ]] && [[ $users = "$package-$old_version" ]] && [[ ! -d $tmpdir/kiin-dest$dir ]] && {
      rm -rv $dir | tee -a $upgrade_log
    }
  done

  # recreate /usr/share/info/dir
  cd /usr/share/info
  rm -v dir
  for f in *; do
    install-info $f dir 2>/dev/null
  done

  # fix /usr/lib/perl5/5.16.1/x86_64-linux/perllocal.pod
  cd /usr/lib/perl5/5.16.1/x86_64-linux
  if [ -e perllocal.pod ]; then
    rm -v perllocal.pod
  fi
  for f in `find . -name "*.podpart"`; do
    cat $f >> perllocal.pod
  done

  cd $startdir
  sudo -u rybalkin mv -v /sources/installed/kiin.$package-$old_version.tar.xz \
    /sources/uninstalled
  sudo -u rybalkin mv -v $2 /sources/installed
  sudo -u rybalkin kiin gen-db
  echo "upgrade log: $upgrade_log"

  exit 0
fi

if [ $1 == 'ls' ]; then
  echo "select name,version from package;" \
    | sqlite3 /sources/kiin-db/kiin.sqlite3 \
    | sed 's/|/\-/g'
  exit 0
fi

if [ $1 == 'uninstall' ]; then
  if [ `kiin list-dups | wc -l` != '0' ]; then
    echo "where are duplicates in the system, not uninstalling"
    exit 0
  fi
  uninstaller=/tmp/kiin/uninstaller-`uuidgen`
  mkdir -p /tmp/kiin
  for file in `kiin db-list-files $package`; do
    echo "rm $file" | tee -a $uninstaller
  done
  for dir in `kiin db-list-dirs $package \
    | awk '{ print length, $0 }' | sort -n -r | cut -d " " --fields=2`; do
    users=`kiin who-uses-dir $dir`
    user_count=`echo $users | wc -w`
    [[ $user_count = 1 ]] && [[ $users = $package ]] && {
      echo "rm -r $dir" | tee -a $uninstaller
    }
  done
  chmod +x $uninstaller
  echo ""
  echo "uninstall script is $uninstaller (check it and run it as root)"
  echo "think you would like to run this as user after that:"
  echo "mv /sources/installed/kiin.$package.tar.xz /sources/uninstalled"
  echo "think you would like to run kiin gen-db as user after that, too"
  exit 0
fi

if [ $1 == 'db-list-files' ]; then
  package=`echo $package | sed 's/\-[^-]*$//g'`
  echo "select name from file where package_id in \
    (select id from package where name='$package') \
    and permissions not like 'd%';" \
    | sqlite3 /sources/kiin-db/kiin.sqlite3 | sort
  exit 0
fi

if [ $1 == 'db-list-dirs' ]; then
  package=`echo $package | sed 's/\-[^-]*$//g'`
  echo "select name from file where package_id in \
    (select id from package where name='$package') \
    and permissions like 'd%';" \
    | sqlite3 /sources/kiin-db/kiin.sqlite3 | sort
  exit 0
fi

if [ $1 == 'list-untracked' ]; then
  if [ ! -d $2 ]; then
    echo "dir $2 does not exist"
    exit 0
  fi
  dir=`echo $2 | sed 's/\/$//g'`
  find $dir ! -type d | db_manager.py list-untracked
  exit 0
fi

if [ $1 == 'check-system-integrity' ]; then
  dirs=
  for i in `ls /`; do
    if [ ! -z "`kiin who-uses-dir /$i | grep -v filesystem`" ]; then
      dirs="$dirs /$i"
    fi
  done
  echo " * searching for untracked files on filesystem..."
  echo " * used system dirs:" $dirs
  for i in $dirs; do
    kiin list-untracked $i
  done
  echo " * searching for missing package files..."
  kiin list-missing
  echo " * searching for duplications in package db..."
  kiin list-dups
  exit 0
fi

if [ $1 == 'list-missing' ]; then
  for package in `kiin ls`; do
    for file in `kiin db-list-files $package`; do
      if [ ! -e $file ]; then
        echo "$file is missing ($package)"
      fi
    done
  done
  exit 0
fi

if [ $1 == 'check-arch-updates' ]; then
  cd ~/sources
  #git pull
  for i in `kiin ls`; do
    package=`echo $i | sed 's/\-[^-]*$//g'`
    version=`echo $i | sed "s/$package-//g"`
    local_package=$package
    [[ $package = 'python' ]] && package='python2'
    [[ $package = 'python2-virtualenv' ]] && package='python-virtualenv'
    [[ $package = 'mpc' ]] && package='libmpc'
    [[ $package = 'udev' ]] && package='systemd'
    [[ $package = 'glib' ]] && package='glib2'
    [[ $package = 'gdk-pixbuf' ]] && package='gdk-pixbuf2'
    [[ $package = 'mpd-mpc' ]] && package='mpc'
    # won't upgrade:
    [[ $package = 'filesystem' ]] && continue
    [[ $package = 'linux-firmware' ]] && continue
    [[ $package = 'cacerts' ]] && continue
    [[ $package = 'lfs-bootscripts' ]] && continue
    [[ $package = 'kiin-git' ]] && continue
    [[ $package = 'kiin-known' ]] && continue
    if [ -d packages/$package ]; then
      . packages/$package/trunk/PKGBUILD
      if [ $pkgver != $version ]; then
        echo "$local_package: local is $version, Arch's ($package) is $pkgver"
      fi
    else
      if [ -d community/$package ]; then
        . community/$package/trunk/PKGBUILD
        if [ $pkgver != $version ]; then
          echo "$local_package: local is $version, Arch's ($package) is $pkgver"
        fi
      else
        echo "  cannot find $package in arch packages"
      fi
    fi
  done

  exit 0
fi

usage
