#!/bin/bash

usage() {
  echo "usage:"
  echo "  kiin make"
  echo "  kiin gen-db"
  echo "  kiin list-dups"
  echo "  kiin who-owns </full/path/to/file>"
  echo "  kiin who-uses-dir </full/path/to/dir>"
  echo "  kiin check-conflicts </path/to/package.xz>"
  echo "  kiin list-files </path/to/package.xz>"
  echo "  kiin list-dirs </path/to/package.xz>"
  echo "  kiin install </path/to/package.xz>"
  echo "  kiin ls"
  echo "  kiin uninstall <package>"
  echo "  kiin list-untracked <dir>"
  #echo "  kiin list-lost </path/to/package.xz>"
}

if [ -z $1 ]; then
  usage
  exit 0
fi

case $1 in
  "install" | "list-untracked")
    if [ `whoami` != 'root' ]; then
      echo "you must be root to run kiin $1"
      exit 0
    fi
    ;;
esac
case $1 in
  "who-owns" | "who-uses-dir" | "check-conflicts" | "list-files" | "list-dirs" | "install" | "uninstall" | "list-untracked")
    if [ -z $2 ]; then
      echo "usage:" && usage | grep $1
      exit 0
    fi
    ;;
esac

if [ $1 == "make" ]; then
  set -e
  if [ ! -f ./package.sh ]; then
    echo "no package.sh found, goodbye."
    exit 0
  fi
  location=`pwd`
  . ./package.sh

  pkgdir=${location}/kiin-dest
  if [[ ${srctar} ]]; then
    echo "unpacking ${srctar}..."
    tar xf ${srctar}
    cd ${srcdir}
  fi
  kiin_make

  maker=${location}/kiin_maker.sh
  cat > ${maker} << "EOF"
#!/bin/sh
cd ${location}
. ./package.sh
mkdir ${pkgdir}
if [[ ${srcdir} ]]; then
  cd ${srcdir}
fi
kiin_install
fix_symlinks.py
cd ${location}
echo creating xz archive...
tar cfa kiin.${pkgname}-${pkgver}.tar.xz kiin-dest
EOF
  chmod +x ${maker}
  location=${location} srcdir=${srcdir} pkgdir=${pkgdir} \
    pkgname=${pkgname} pkgver=${pkgver} fakeroot ${maker}
  rm ${maker}
  rm -rf ${pkgdir}
  if [[ ${srcdir} ]]; then
    rm -rf ${srcdir}
  fi
  echo "kiin: all done!"
  exit 0
fi

if [ $1 == 'gen-db' ]; then
  rm -f /sources/kiin-db/*.list
  for i in `find /sources/installed/ -type f`; do
    filename="`echo $i | sed 's/\/sources\/installed\/kiin\.//g' | sed 's/\.tar\.xz//g'`"
    tar -tvf $i | sed "s/kiin-dest//g" > /sources/kiin-db/$filename.list
  done
  echo done
  exit 0
fi

if [ $1 == 'list-dups' ]; then
  # select name, count(id) as cnt from file where permissions not like 'd%' group by name order by cnt desc
  find /sources/kiin-db -name "*.list" | xargs cat | tr -s ' ' | grep -E '^[-lpscb].*' | cut -d ' ' --fields=6 | sort | uniq -c | grep -E -v "      1 .*" | sort -r -n
  exit 0
fi

if [ $1 == 'who-owns' ]; then
  for i in `find /sources/kiin-db/ -name "*.list"`; do
    cat $i | sed 's/\ \->\ .*//g' | grep -q -E "^[-lpscb].* $2$"
    if [ $? -eq 0 ]; then
      echo `echo $i | sed 's/\/sources\/kiin-db\///g' | sed 's/\.list//g'`
    fi
  done
  exit 0
fi

if [ $1 == 'who-uses-dir' ]; then
  dir=`echo $2 | sed 's/\/$//g'`
  for i in `find /sources/kiin-db/ -name "*.list"`; do
    cat $i | sed 's/\ \->\ .*//g' | grep -q -E "^d.* $dir\/$"
    if [ $? -eq 0 ]; then
      echo `echo $i | sed 's/\/sources\/kiin-db\///g' | sed 's/\.list//g'`
    fi
  done
  exit 0
fi

# TODO: take filesystem symlinks into account
if [ $1 == 'check-conflicts' ]; then
  if [ ! -f $2 ]; then
    echo "$2 does not exist"
    exit 0
  fi
  for i in `kiin list-files $2`; do
    if [ -e $i ]; then
      echo $i already exists on filesystem
    fi
  done
  for i in `kiin list-dirs $2`; do
    i=`echo $i | sed 's/\/$//g'`
    if [ -e $i ]; then
      if [ ! -d $i ]; then
        echo "$i already exists on filesystem and is not a dir"
      fi
    fi
  done
  exit 0
fi

if [ $1 == 'list-files' ]; then
  if [ ! -f $2 ]; then
    echo "$2 does not exist"
    exit 0
  fi
  tar -tvf $2 | sed 's/kiin-dest//g' | tr -s ' ' | grep -E '^[-lpscb].*' | cut -d ' ' --fields=6 | sort
  exit 0
fi

if [ $1 == 'list-dirs' ]; then
  if [ ! -f $2 ]; then
    echo "$2 does not exist"
    exit 0
  fi
  tar -tvf $2 | sed 's/kiin-dest//g' | tr -s ' ' | grep -E '^d.*' | cut -d ' ' --fields=6 | sort
  exit 0
fi

# TODO: take filesystem symlinks into account
if [ $1 == 'install' ]; then
  if [ ! -f $2 ]; then
    echo "$2 does not exist"
    exit 0
  fi
  if [ `kiin check-conflicts $2 | wc -l` != '0' ]; then
    echo "where are conflicts, not installing"
    exit 0
  fi
  tmpdir=/tmp/kiin/`uuidgen`
  mkdir -p $tmpdir
  tar xf $2 -C $tmpdir
  for dir in `kiin list-dirs $2`; do
    if [ ! -d $dir ]; then
      prototype=$tmpdir/kiin-dest$dir
      mkdir -pv $dir
      chmod `stat -c %a $prototype` $dir
      #echo "chown `stat -c %U $prototype`:`stat -c %G $prototype` $dir"
    fi
  done
  for file in `kiin list-files $2`; do
    prototype=$tmpdir/kiin-dest$file
    cp -av $prototype $file
  done
  exit 0
fi

if [ $1 == 'ls' ]; then
  for i in `find /sources/installed -type f`; do
    echo $i | sed 's/\/sources\/installed\/kiin\.//g' | sed 's/\.tar\.xz//g'
  done
  exit 0
fi

if [ $1 == 'uninstall' ]; then
  count=`kiin ls | grep $2 | wc -l`
  if [ $count = 0 ]; then
    echo "$2 is not installed"
    exit 0
  fi
  if [ $count -gt 1 ]; then
    echo "$2 is ambiguous (" `kiin ls | grep $2` ")"
    exit 0
  fi
  package=`kiin ls | grep $2`
  #echo "uninstalling $package, are you sure? (y/N)"
  uninstaller=/tmp/kiin/uninstaller-`uuidgen`
  mkdir -p /tmp/kiin
  for file in `cat /sources/kiin-db/$package.list | tr -s ' ' | grep -E '^[-lpscb].*' | cut -d ' ' --fields=6 | sort`; do
    kiin list-files /sources/installed/kiin.filesystem-1.tar.xz | grep -q -E "^$file$"
    if [ ! $? -eq 0 ]; then
      if [ $file != "/usr/share/info/dir" ]; then
        owners=`kiin who-owns $file`
        owner_count=`echo $owners | wc -w`
        if [ $owner_count != 1 ]; then
          echo $file owned by $owner_count owners: $owners
          exit 0
        fi
        if [ "$owners" != $package ]; then
          echo "$package is not owner of $file"
          exit 0
        fi
        echo "rm $file" | tee -a $uninstaller
      fi
    fi
  done
  for dir in `cat /sources/kiin-db/$package.list | tr -s ' ' | grep -E '^d.*' | cut -d ' ' --fields=6 | awk '{ print length, $0 }' | sort -n -r | cut -d " " --fields=2`; do
    kiin list-dirs /sources/installed/kiin.filesystem-1.tar.xz | grep -q -E "^$dir$"
    if [ ! $? -eq 0 ]; then
      users=`kiin who-uses-dir $dir`
      user_count=`echo $users | wc -w`
      [ $user_count = 1 ] && [ $users = $package ] && {
        echo "rm -r $dir" | tee -a $uninstaller
      }
    fi
  done
  chmod +x $uninstaller
  echo ""
  echo "uninstall script is $uninstaller (check it and run it as root)"
  echo "think you would like to run this as user after that:"
  echo "mv /sources/installed/kiin.$package.tar.xz /sources/uninstalled"
  echo "think you would like to run kiin gen-db as user after that, too"
  exit 0
fi

if [ $1 == 'list-untracked' ]; then
  if [ ! -d $2 ]; then
    echo "dir $2 does not exist"
    exit 0
  fi
  dir=`echo $2 | sed 's/\/$//g'`
  for file in `find $dir ! -type d`; do
    owner=`kiin who-owns $file`
    if [ -z $owner ]; then
      echo "nobody owns $file"
    fi
  done
  exit 0
fi

usage
