#!/bin/sh
set -e

if [ -z ./package.sh ]; then
  echo "no package.sh found, goodbye."
fi
location=`pwd`
. ./package.sh

pkgdir=${location}/kiin-dest
if [[ ${srctar} ]]; then
  echo "unpacking ${srctar}..."
  tar xf ${srctar}
  cd ${srcdir}
fi
kiin_make

maker=${location}/kiin_maker.sh
cat > ${maker} << "EOF"
#!/bin/sh
cd ${location}
. ./package.sh
mkdir ${pkgdir}
if [[ ${srcdir} ]]; then
  cd ${srcdir}
fi
kiin_install
fix_symlinks.py
cd ${location}
echo creating xz archive...
tar cfa kiin.${pkgname}-${pkgver}.tar.xz kiin-dest
EOF
chmod +x ${maker}
location=${location} srcdir=${srcdir} pkgdir=${pkgdir} \
  pkgname=${pkgname} pkgver=${pkgver} fakeroot ${maker}
rm ${maker}
rm -rf ${pkgdir}
if [[ ${srcdir} ]]; then
  rm -rf ${srcdir}
fi
echo "kiin: all done!"
