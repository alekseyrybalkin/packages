#vcs=none
pkgname=p7zip
pkgver=16.02
urls="https://downloads.sourceforge.net/project/${pkgname}/${pkgname}/${pkgver}/${pkgname}_${pkgver}_src_all.tar.bz2"
srctar=${pkgname}_${pkgver}_src_all.tar.bz2
srcdir=${location}/${pkgname}_${pkgver}
relmon_id=2583

build() {
    # https://sourceforge.net/p/p7zip/bugs/226/ (patch from Fedora)
    patch -Np1  -i ../gcc10-conversion.patch

    # https://sourceforge.net/p/p7zip/bugs/185/
    patch -Np1 -i ../CVE-2016-9296.patch

    # https://sourceforge.net/p/p7zip/bugs/204/
    patch -Np1 -i ../CVE-2017-17969.patch

    # Security patches from Debian
    patch -Np1 -i ../CVE-2018-5996.patch
    patch -Np1 -i ../CVE-2018-10115.patch

    cp makefile.linux_amd64_asm makefile.machine

    make all3 OPTFLAGS="${CFLAGS}"
}

package() {
    make install \
        DEST_DIR=${pkgdir} \
        DEST_HOME=/usr \
        DEST_MAN=/usr/share/man

    # Remove documentation for the GUI file manager
    rm -r ${pkgdir}/usr/share/doc/p7zip/DOC/MANUAL/fm
}
