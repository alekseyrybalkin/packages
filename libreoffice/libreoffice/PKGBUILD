pkgname=libreoffice
ARCH_NAME=libreoffice-fresh
_majorver=6.4.2
pkgver=${_majorver}.2
vcs=git
gittag=libreoffice-${pkgver}
tarball_dirs="libreoffice-tarballs"
relmon_id=6506
relmon_rules="skip_alpha,skip_beta"

prepare() {
    git clone -s -n `find_vcs_repo libreoffice` libreoffice-${pkgver}
    cd libreoffice-${pkgver}
    git checkout ${gittag} download.lst
    python ../libreoffice_prepare_deps.py ${TARBALLS_HOME}/libreoffice-tarballs
    cd ../
    rm -rf libreoffice-${pkgver}
}

build() {
    patch -p1 -i ../libreoffice-poppler-0.86.patch
    patch -Np1 -i ../make-pyuno-work-with-system-wide-module-install.diff

    mkdir -p external/tarballs/tmp
    cp ${TARBALLS_HOME}/libreoffice-tarballs/* external/tarballs/tmp/
    sed -i -e 's/\$(WGET)/true/g' Makefile.fetch

    sed -e "/gzip -f/d" \
        -e "s|.1.gz|.1|g" \
        -i bin/distro-install-desktop-integration
    sed -e "/distro-install-file-lists/d" -i Makefile.in

    sed -e '/JAVA_SOURCE_VER/s/6/7/' \
        -e '/JAVA_TARGET_VER/s/6/7/' \
        -i configure.ac

    ./autogen.sh --prefix=/usr \
        --sysconfdir=/etc \
        --with-vendor="jinni_gnu_linux" \
        --with-lang="en-US" \
        --without-java \
        --without-junit \
        --without-system-dicts \
        --without-system-qrcodegen \
        --disable-odk \
        --disable-firebird-sdbc \
        --disable-postgresql-sdbc \
        --enable-python=system \
        --enable-release-build=yes \
        --with-system-apr \
        --with-system-cairo \
        --with-system-curl \
        --with-system-expat \
        --with-system-icu \
        --with-system-jpeg \
        --with-system-lcms2 \
        --with-system-libpng \
        --with-system-libxml \
        --with-system-nss \
        --with-system-serf \
        --with-system-zlib \
        --with-system-boost \
        --with-system-librevenge \
        --with-system-libfreehand \
        --with-system-epoxy \
        --disable-gstreamer-1-0 \
        --disable-dbus \
        --enable-gtk3 \
        --with-parallelism=$(getconf _NPROCESSORS_ONLN)
    make build-nocheck
}

package() {
    make DESTDIR=${pkgdir} distro-pack-install
    rm -rf ${pkgdir}/gid_Module_*

    PYLIB_PATH=${pkgdir}`python -c "import sys; print('/usr/lib/python{}.{}'.format(sys.version_info.major, sys.version_info.minor))"`
    install -dm755 ${PYLIB_PATH}/site-packages
    ln -svf /usr/lib/libreoffice/program/uno.py \
        ${PYLIB_PATH}/site-packages/uno.py
    ln -svf /usr/lib/libreoffice/program/unohelper.py \
        ${PYLIB_PATH}/site-packages/unohelper.py
}

after_install() {
    update-desktop-database -q
    update-mime-database /usr/share/mime
}

after_upgrade() {
    after_install
}

generated_files="usr/share/mime/application/vnd.ms-word.xml \
    usr/share/mime/application/vnd.oasis.opendocument.text-master-template.xml \
    usr/share/mime/application/vnd.sun.xml.base.xml"
